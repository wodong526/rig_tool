# coding=gbk
import maya.cmds as mc
import maya.api.OpenMaya as om
import maya.api.OpenMayaAnim as omain

from feedback_tool import Feedback_info as fp


def getApiNode(obj=None, dag=True, com=False):
    """
    获取对象的MDagPath
    :param com: 如果需要获取的是组件，则返回组件的dagPath
    :param dag: 是否只返回dag节点
    :param obj:(str) 要获取的对象
    :return:
    """
    if obj:
        sel = om.MGlobal.getSelectionListByName(obj)
    else:
        sel = om.MGlobal.getActiveSelectionList()

    if sel.isEmpty():
        fp('没有指定任何对象。', error=True)
        return None

    if dag:
        if com:
            return sel.getComponent(0)
        else:
            return sel.getDagPath(0)
    else:
        return sel.getDependNode(0)


def getMPoint(obj):
    """
    获取给定对象的世界xyz坐标
    :param obj: 要获取坐标的对象
    :return: MPoint类型
    """
    pos = mc.xform(obj, q=True, t=True, ws=True)

    return om.MPoint(pos[0], pos[1], pos[2], 1.0)


def getGeometryComponents(fn_skin):
    """
    从MFnSkinCluster类型对象获取该节点的dagPath对象和蒙皮组件对象
    :param fn_skin:MFnSkinCluster节点
    :return:蒙皮节点的dagPath对象、蒙皮节点的组件节点
    """
    for ii in range(fn_skin.findPlug("input", False).evaluateNumElements()):
        # get the input shape and component for this index
        shape_obj = fn_skin.inputShapeAtIndex(ii)
        shape_dag_path = om.MDagPath.getAPathTo(shape_obj)
        transform_dag_path = om.MDagPath(shape_dag_path)
        transform_dag_path.pop()
        component = fn_skin.getComponentAtIndex(ii)

        return transform_dag_path, component

def getCurrentWeights(fn_skin, dag_path, components, influences_nam=None):
    """
    通过MFnSkinCluster对象获取该蒙皮节点的权重列表
    :param influences_nam: 当指定关节名称时返回该关节的权重
    :param fn_skin: MFnSkinCluster节点
    :param dag_path: 蒙皮对象的dagPath对象
    :param components: 蒙皮对象的组件对象
    :return:权重数组，排列依据为：第一个点的按关节顺序的权重值、第二个点的・・・・
    """
    if not influences_nam:
        return fn_skin.getWeights(dag_path, components)[0]

    try:
        return fn_skin.getWeights(dag_path, components, fromSkinGetInfluence(fn_skin).index(influences_nam))
    except ValueError:
        fp('蒙皮关节{}不存在'.format(influences_nam), warning=True)
        return None

def setCurrentWeights(fn, weights, influences_num, dag_path, components):
    """
    将权重列表的值赋予到MFnSkinCluster对象
    :param fn: MFnSkinCluster节点
    :param weights: 权重值列表
    :param influences_num: 影响关节对象
    :param dag_path: 蒙皮节点的dagPath对象
    :param components: 蒙皮节点的组件节点
    :return:
    """
    influenceIndices = om.MIntArray()
    for ii in range(influences_num):
        influenceIndices.insert(ii, ii)
    fn.setWeights(dag_path, components, influenceIndices, weights)

def get_skinModelName(skin_cluster_fn):
    """
    通过MFnSkinCluster对象获取被蒙皮对象的名字
    :param skin_cluster_fn:
    :return:
    """
    if type(skin_cluster_fn) == omain.MFnSkinCluster:
        pass
    else:
        fp('参数{}不是MFnSkinCluster对象'.format(skin_cluster_fn))

    influenced_objects = skin_cluster_fn.getOutputGeometry()
    influenced_model_names = []
    for i in range(influenced_objects.__len__()):
        influenced_model_fn = om.MFnDagNode(influenced_objects[i])
        influenced_model_name = influenced_model_fn.partialPathName()
        influenced_model_names.append(influenced_model_name)

    return influenced_model_names

def get_skinModelType(skin_cluster_fn):
    """
    通过MFnSkinCluster对象获取被蒙皮对象的类型
    :param skin_cluster_fn: MFnSkinCluster节点
    :return:被蒙皮对象类型名称
    """
    if type(skin_cluster_fn) == omain.MFnSkinCluster:
        pass
    else:
        fp('参数{}不是MFnSkinCluster对象'.format(skin_cluster_fn))

    influenced_objects = skin_cluster_fn.getInputGeometry()
    for i in range(influenced_objects.__len__()):
        input_object = influenced_objects[i]
        dg_iterator = om.MItDependencyGraph(input_object, om.MFn.kInvalid, om.MItDependencyGraph.kUpstream,
                                            om.MItDependencyGraph.kDepthFirst, om.MItDependencyGraph.kPlugLevel)

        while not dg_iterator.isDone():
            current_node = dg_iterator.currentNode()
            if current_node.hasFn(om.MFn.kNurbsSurface):
                return 'nurbsSurface'
            elif current_node.hasFn(om.MFn.kNurbsCurve):
                return 'nurbsCurve'
            elif current_node.hasFn(om.MFn.kMesh):
                return 'mesh'

            dg_iterator.next()


def fromObjGetRigNode(obj=None, skin=True, blend_shape=False, path_name=True):
    """
    从字符串的transform对象获取该模型的绑定相关类型节点
    :param blend_shape: 获取bs节点
    :param skin: 蒙皮节点
    :param obj: transform对象字符串
    :param path_name: 返回时是否返回api对象列表，为真（默认）时返回节点名字列表
    :return:绑定相关节点列表
    """
    if not isinstance(obj, om.MDagPath):
        dagNode = getApiNode(obj)
    else:
        dagNode = obj

    try:
        dagNode.extendToShape()
    except RuntimeError:
        fp('对象{}没有shape节点或不止一个shape节点。'.format(dagNode.partialPathName()), error=True)
    m_object = dagNode.node()

    if skin:
        itDG = om.MItDependencyGraph(m_object, om.MFn.kSkinClusterFilter, om.MItDependencyGraph.kUpstream)
    elif blend_shape:
        itDG = om.MItDependencyGraph(m_object, om.MFn.kBlendShape, om.MItDependencyGraph.kUpstream)
    else:
        fp('没有指定要获取的节点对象。', error=True)

    ret_lis = []
    while not itDG.isDone():
        item = itDG.currentNode()

        skin = omain.MFnSkinCluster(item) if skin else omain.MFnBlendShapeDeformer(item)
        ret_lis.append(skin)
        itDG.next()


    if path_name:
        return [node.name() for node in ret_lis]
    else:
        return ret_lis


def fromSkinGetInfluence(fn_skin):
    """
    从MFnSkinCluster对象获影响关节
    :param fn_skin:MFnSkinCluster对象
    :return:影响关节列表
    """
    influence_lis = []
    dagArr = fn_skin.influenceObjects()
    for i in range(dagArr.__len__()):
        if om.MFnDagNode(dagArr[i]).typeName == 'joint':
            influence_lis.append(dagArr[i].partialPathName())

    return influence_lis
