# -*- coding:GBK -*-
import maya.cmds as mc
import maya.mel as mm

import os
import sys

from feedback_tool import Feedback_info as fb_print, LIN as lin


class RIG_setUp(object):
    """
    添加图片路径环境
    生成菜单
    生成热盒
    添加meta脚本插件
    设置默认路径为工作区
    """

    def __init__(self):
        if os.path.exists('C:/Rig_Tools'):
            #self.renew_svn()
            self.add_toolScript_path()
            self.create_IconPath()
            self.create_menu()
            self.create_hotBox()
            self.add_metaToMata_plug()
            self.set_defaultWorlkSpace()
        else:
            fb_print('找不到插件路径，请到服务器安装工具架。', error=True)

    def renew_svn(self):
        import svn_tool
        svn_tool.svn_upData()
        fb_print('工具架同步成功', info=True, viewMes=True)

    def add_toolScript_path(self):
        sys.path.append('C:/Rig_Tools/tools')
        sys.path.append('C:/Rig_Tools/scripts/plug_ins')

    def create_IconPath(self):
        if 'C:\Rig_Tools\icons' not in os.environ['XBMLANGPATH']:
            os.environ['XBMLANGPATH'] = str(os.environ['XBMLANGPATH']) + ';' + r'C:\Rig_Tools\icons'

    def create_menu(self):
        import reload_tools
        reload(reload_tools)
        reload_tools.reload_menu_ui()

    def create_hotBox(self):
        import reload_tools
        reload(reload_tools)
        reload_tools.reload_hot_ui()

    def add_metaToMata_plug(self):
        try:
            if mc.pluginInfo('embeddedRL4', q=True, r=True):
                fb_print('bridgeToMaya已经加载。', info=True)
            else:
                if 'C:/Rig_Tools/scripts/Bridge_To_Maya' not in sys.path:
                    sys.path.append('C:/Rig_Tools/scripts/Bridge_To_Maya')

                from DHI import DHIPluginLoader
                import LiveLink
                DHIPluginLoader.load()  #添加meta脚本插件
                if not mc.about(b=True):#在批处理模式下监听器会导致出现QWidget: Cannot create a QWidget without QApplication
                    LiveLink.initLiveLink()  #实时链接
                fb_print('已加载bridgeToMaya {}插件集。'.format(LiveLink.MAYA_PLUGIN_VERSION), info=True)

        except Exception as e:
            rest = mc.confirmDialog(title='插件加载失败：', message='请注意，你的metaToMaya插件加载可能失败。\n{}'.format(e),
                                    button=['确定', '检查插件管理器'])
            if rest == u'检查插件管理器':
                mm.eval('PluginManager;')
            fb_print('bridgeToMaya插件集加载失败。', error=True)

    def set_defaultWorlkSpace(self):
        """
        将工作区设置为默认路径，而非meta的路径
        :return:
        """
        document_path = mc.internalVar(uad=True)
        mc.workspace('{}projects/default'.format(document_path), o=True)


#if not mc.about(batch=True):
mc.evalDeferred('RIG_setUp()')
